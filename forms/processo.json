{
    "className": "org.joget.apps.form.model.Form",
    "elements": [
        {
            "className": "org.joget.apps.form.model.Section",
            "elements": [{
                "className": "org.joget.apps.form.model.Column",
                "elements": [
                    {
                        "className": "org.joget.plugin.enterprise.MultiPagedForm",
                        "properties": {
                            "ajaxMode": "",
                            "css": "",
                            "displayMode": "tab",
                            "id": "multiPaged",
                            "nextButtonlabel": "PRÓXIMO",
                            "numberOfPage": {
                                "className": "11",
                                "properties": {
                                    "page10_formDefId": "comunicacoes",
                                    "page10_label": "Comunicações",
                                    "page10_parentSubFormId": "comunicacoes",
                                    "page10_readonly": "",
                                    "page10_readonlyLabel": "",
                                    "page10_subFormParentId": "id_processo",
                                    "page10_validate": "",
                                    "page11_formDefId": "geral",
                                    "page11_label": "Operativa",
                                    "page11_parentSubFormId": "geral",
                                    "page11_readonly": "",
                                    "page11_readonlyLabel": "",
                                    "page11_subFormParentId": "id_processo",
                                    "page11_validate": "",
                                    "page1_formDefId": "menuPrincipal2",
                                    "page1_label": "Resumo",
                                    "page1_parentSubFormId": "detalhe_processo",
                                    "page1_readonly": "",
                                    "page1_readonlyLabel": "",
                                    "page1_subFormParentId": "",
                                    "page1_validate": "",
                                    "page2_formDefId": "detalheProcesso",
                                    "page2_label": "Processo",
                                    "page2_parentSubFormId": "detalhe_processo",
                                    "page2_readonly": "",
                                    "page2_readonlyLabel": "",
                                    "page2_subFormParentId": "id_processo",
                                    "page2_validate": "",
                                    "page3_formDefId": "intervenientes",
                                    "page3_label": "Intervenientes",
                                    "page3_parentSubFormId": "intervenientes",
                                    "page3_readonly": "",
                                    "page3_readonlyLabel": "",
                                    "page3_subFormParentId": "id_processo",
                                    "page3_validate": "",
                                    "page4_formDefId": "documentos",
                                    "page4_label": "Documentos",
                                    "page4_parentSubFormId": "docs",
                                    "page4_readonly": "",
                                    "page4_readonlyLabel": "",
                                    "page4_subFormParentId": "id_processo",
                                    "page4_validate": "",
                                    "page5_formDefId": "imoveis",
                                    "page5_label": "Imóveis",
                                    "page5_parentSubFormId": "imoveis",
                                    "page5_readonly": "",
                                    "page5_readonlyLabel": "",
                                    "page5_subFormParentId": "id_processo",
                                    "page5_validate": "",
                                    "page6_formDefId": "banco",
                                    "page6_label": "Banco",
                                    "page6_parentSubFormId": "banco",
                                    "page6_readonly": "",
                                    "page6_readonlyLabel": "",
                                    "page6_subFormParentId": "id_processo",
                                    "page6_validate": "",
                                    "page7_formDefId": "analiseBancaria",
                                    "page7_label": "Análise Bancária",
                                    "page7_parentSubFormId": "anal_banc",
                                    "page7_readonly": "",
                                    "page7_readonlyLabel": "",
                                    "page7_subFormParentId": "id_processo",
                                    "page7_validate": "",
                                    "page8_formDefId": "analiseLegal",
                                    "page8_label": "Análise Legal",
                                    "page8_parentSubFormId": "anal_legal",
                                    "page8_readonly": "",
                                    "page8_readonlyLabel": "",
                                    "page8_subFormParentId": "id_processo",
                                    "page8_validate": "",
                                    "page9_formDefId": "esclarecimentos",
                                    "page9_label": "Diligências",
                                    "page9_parentSubFormId": "esclarecimentos",
                                    "page9_readonly": "",
                                    "page9_readonlyLabel": "",
                                    "page9_subFormParentId": "id_processo",
                                    "page9_validate": ""
                                }
                            },
                            "onlyAllowSubmitOnLastPage": "",
                            "partiallyStore": "true",
                            "prevButtonlabel": "ANTERIOR",
                            "storeMainFormOnPartiallyStore": "true"
                        }
                    },
                    {
                        "className": "org.joget.apps.form.lib.CustomHTML",
                        "properties": {
                            "autoPopulate": "",
                            "id": "edicao_botoes_default",
                            "label": "",
                            "value": "<script type=\"text/javascript\">\r\n$(function(){\r\n    var flagUltimaAtividade='#variable.flag_ultima_atividade#';\r\n    console.log(flagUltimaAtividade);\r\n    if(flagUltimaAtividade == 1){\r\n        $(\"#assignmentComplete\").val(\"PROXIMA OPERATIVA\");\r\n        $(\"#saveAsDraft\").val(\"GUARDAR\");\r\n        $(\"#cancel\").text(\"CANCELAR\"); \r\n\r\n    }else{\r\n        $(\"#assignmentComplete\").val(\"PROXIMA ATIVIDADE\");\r\n        $(\"#saveAsDraft\").val(\"GUARDAR\");~~\r\n        $(\"#cancel\").text(\"CANCELAR\"); \r\n    }\r\n\r\n \r\n});\r\n<\/script>"
                        }
                    }
                ],
                "properties": {"width": "100%"}
            }],
            "properties": {
                "comment": "",
                "id": "section1",
                "join": "",
                "label": "Plataforma Legal",
                "loadBinder": {
                    "className": "",
                    "properties": {}
                },
                "permission": {
                    "className": "",
                    "properties": {}
                },
                "permissionReadonly": "",
                "readonly": "",
                "readonlyLabel": "",
                "regex": "",
                "reverse": "",
                "storeBinder": {
                    "className": "",
                    "properties": {}
                },
                "visibilityControl": "",
                "visibilityValue": ""
            }
        },
        {
            "className": "org.joget.apps.form.model.Section",
            "elements": [{
                "className": "org.joget.apps.form.model.Column",
                "elements": [{
                    "className": "org.joget.apps.form.lib.TextField",
                    "properties": {
                        "encryption": "",
                        "id": "robot",
                        "label": "Robot",
                        "maxlength": "",
                        "placeholder": "",
                        "readonly": "",
                        "readonlyLabel": "",
                        "size": "",
                        "storeNumeric": "",
                        "style": "",
                        "validator": {
                            "className": "",
                            "properties": {}
                        },
                        "value": "",
                        "workflowVariable": ""
                    }
                }],
                "properties": {"width": "100%"}
            }],
            "properties": {
                "comment": "",
                "id": "section2",
                "join": "",
                "label": "Robot",
                "loadBinder": {
                    "className": "",
                    "properties": {}
                },
                "permission": {
                    "className": "",
                    "properties": {}
                },
                "permissionReadonly": "",
                "readonly": "",
                "readonlyLabel": "",
                "regex": "",
                "reverse": "",
                "storeBinder": {
                    "className": "",
                    "properties": {}
                },
                "visibilityControl": "",
                "visibilityValue": ""
            }
        }
    ],
    "properties": {
        "description": "",
        "id": "processo",
        "loadBinder": {
            "className": "org.joget.apps.form.lib.WorkflowFormBinder",
            "properties": {}
        },
        "name": "CHG - 1 - Processo",
        "noPermissionMessage": "",
        "permission": {
            "className": "",
            "properties": {}
        },
        "postProcessor": {
            "className": "org.joget.apps.app.lib.BeanShellTool",
            "properties": {"script": "import org.joget.apps.form.model.Element;\r\nimport org.joget.workflow.model.service.*;\r\nimport org.joget.commons.util.LogUtil;\r\nimport java.util.Arrays;\r\nimport org.joget.apps.form.model.Form;\r\nimport org.joget.apps.form.model.FormData;\r\nimport org.joget.apps.form.service.FormUtil;\r\nimport java.util.Map;\r\nimport javax.servlet.http.HttpServletRequest;\r\nimport org.joget.apps.app.model.AppDefinition;\r\nimport org.joget.apps.app.service.AppPluginUtil;\r\nimport org.joget.apps.app.service.AppUtil;\r\nimport org.joget.plugin.base.ApplicationPlugin;\r\nimport org.joget.plugin.base.Plugin;\r\nimport org.joget.plugin.base.PluginManager;\r\nimport org.joget.plugin.property.model.PropertyEditable;\r\n\r\nimport java.sql.Connection;\r\nimport java.sql.PreparedStatement;\r\nimport java.sql.ResultSet;\r\nimport java.sql.SQLException;\r\nimport javax.sql.DataSource;\r\nimport org.joget.commons.util.UuidGenerator;\r\nimport java.time.LocalDate;\r\n  \r\n\r\npublic Object execute(AppDefinition appDef, HttpServletRequest request) {\r\n\r\n    String ProcessID = workflowAssignment.getProcessId();\r\n    String Username = \"#currentUser.username#\";\r\n    String Performer = \"#process.activityInst.{assignment.activityDefId}.performer#\";\r\n    String LaneUser = \"user_\" + Performer;\r\n    String EstadoContratacao = \"#form.detalhe_processo.estado_contratacao[{form.processos.detalhe_processo}]#\";\r\n    String EstadoContratacaoEval = \"\";\r\n    String DetalheProcesso = \"#form.processos.detalhe_processo#\";\r\n    int SlaToApplyMin = 0;\r\n    WorkflowManager wm = (WorkflowManager) pluginManager.getBean(\"workflowManager\");\r\n    //Set workflow variables- \r\n    //Last Lane user for reasignment purposes\r\n    wm.processVariable(ProcessID, LaneUser , Username);\r\n    LogUtil.info(\"BeanShell set WF Var\", \"Detalhe do Processo: \" + DetalheProcesso);\r\n    LogUtil.info(\"BeanShell set WF Var\", \"Estado de Contratacao: \" + EstadoContratacao);\r\n   // wm.processVariable(ProcessID, \"estado\" , EstadoContratacao);\r\n    // - State - \"estado\"\r\n    \r\n    /*    EstadoContratacaoEval = AppUtil.processHashVariable(EstadoContratacao,null,null,null);\r\n    LogUtil.info(\"BeanShell set WF Var\", \"Estado de Contratacao EVAL: \" + EstadoContratacaoEval);\r\n    EstadoContratacao = \"#form.detalhe_processo.estado_contratacao#\";\r\n    LogUtil.info(\"BeanShell set WF Var\", \"Estado de Contratacao: \" + EstadoContratacao);*/\r\n    \r\n    \r\n    //SlaToApplyMin = 5;\r\n    \r\n    \r\n    \r\n    ////////////////////////////SLA//////////////////////////////\r\n    \r\n    /***************    É EXECUTADO SOMENTE QUANDO O UTILIZADOR PASSA A ATIVIDADE  ********************/\r\n    \r\n    String proximaoperativa = \"#variable.proxima_operativa#\";\r\n    Connection con = null;\r\n    PreparedStatement stmt = null;\r\n    ResultSet rs = null;\r\n    try{\r\n            DataSource ds = (DataSource)AppUtil.getApplicationContext().getBean(\"setupDataSource\");\r\n            con = ds.getConnection();\r\n            \r\n            if(!con.isClosed()){\r\n               \r\n               //Caso a operativa seja contratação   (Em caso de não dar para utilizar criar variável que indica a operativa atual)\r\n               if(proximaoperativa.trim() == \"contratacao\" || proximaoperativa.trim() = \"\"){\r\n                \r\n                   if(EstadoContratação != \"PND\")\r\n                      \r\n                      \r\n                      \r\n                      \r\n                   }\r\n               }\r\n               \r\n            }\r\n            \r\n        }catch(Exception e){\r\n            LogUtil.error(appDef.toString(), e, \"Error getting info from DB\");\r\n        }finally{\r\n            try{\r\n                if(rs != null){\r\n                rs.close();\r\n                }\r\n                if(stmt != null){\r\n                    stmt.close();\r\n                }\r\n                if(con != null && !con.isClosed()) {\r\n                    con.close();\r\n                }\r\n            }catch(Exception e){\r\n                LogUtil.error(appDef.toString(), e, \"Error closing DB connection\");\r\n            }\r\n            \r\n        }\r\n    \r\n    \r\n    return null;\r\n    \r\n}\r\n\r\nreturn execute(appDef, request);\r\n        \r\n\r\n"}
        },
        "postProcessorRunOn": "both",
        "storeBinder": {
            "className": "org.joget.apps.form.lib.BeanShellFormBinder",
            "properties": {
                "autoHandleFiles": "",
                "autoHandleWorkflowVariable": "true",
                "cacheInterval": "",
                "script": "import org.joget.apps.app.service.AppUtil;\r\nimport org.joget.apps.form.model.Element;\r\nimport org.joget.apps.form.model.FormData;\r\nimport org.joget.apps.form.model.FormRow;\r\nimport org.joget.apps.form.model.FormRowSet;\r\nimport org.joget.apps.form.model.FormStoreBinder;\r\nimport org.joget.plugin.base.PluginManager;\r\n\r\nimport java.sql.Connection;\r\nimport java.sql.PreparedStatement;\r\nimport java.sql.ResultSet;\r\nimport java.sql.SQLException;\r\nimport javax.sql.DataSource;\r\nimport org.joget.commons.util.UuidGenerator;\r\nimport java.time.LocalDate;\r\nimport org.joget.workflow.model.service.*;\r\nimport org.joget.commons.util.LogUtil;\r\nimport java.time.LocalDateTime; \r\nimport java.time.format.DateTimeFormatter;\r\nimport org.joget.apps.form.service.FormUtil;\r\nimport org.joget.apps.app.model.AppDefinition;\r\n  \r\npublic String calculateSLAD(String dataInicio){\r\n\r\n    DateTimeFormatter formatter = DateTimeFormatter.ofPattern(\"yyyy-MM-dd HH:mm\");\r\n    LocalDateTime dateInit = LocalDateTime.parse(dataInicio, formatter);  \r\n    String endDate = \"\";\r\n    \r\n    var hour = dateInit.getHour();\r\n    \r\n    if(hour < 12){\r\n       endDate = dateInit.withHour(23).withMinute(59).format(formatter);\r\n    }else{\r\n        endDate = dateInit.plusDays(1).withHour(12).withMinute(0).format(formatter);\r\n        \r\n    }\r\n    \r\n    return endDate;\r\n}\r\n\r\npublic FormRowSet store(Element element, FormRowSet rows, FormData formData) {\r\n    \r\n    if (rows != null && !rows.isEmpty()) {\r\n    \r\n        PluginManager pluginManager = (PluginManager) AppUtil.getApplicationContext().getBean(\"pluginManager\");\r\n        FormStoreBinder binder = (FormStoreBinder) pluginManager.getPlugin(\"org.joget.apps.form.lib.WorkflowFormBinder\");\r\n        binder.store(element, rows, formData);\r\n    }\r\n    \r\n    \r\n    \r\n    /////////////////////////   SLA   /////////////////////////////////\r\n    \r\n    /*********************************      É EXECUTADO QUANDO O UTILIZADOR GUARDA O FORMULÁRIO, PASSA DE TAB NO MULTIFORM OU AVANÇA PARA A PROXIMA ATIVIDADE    **********************************/\r\n    \r\n    //Processo é criado, SLA em estado de 'Em curso'\r\n    //Processo fica em pendente, é 'fechado' o SLA, e criado um novo com estado de 'Pendente'\r\n    //Processo sai de pendente, o estado passa de 'Pendente' a 'Em curso'\r\n    \r\n    String ProcessID = \"#process.processId#\";\r\n    String EstadoContratacao = \"#form.detalhe_processo.estado_contratacao[{form.processos.detalhe_processo}]#\";\r\n    AppDefinition appDef = AppUtil.getCurrentAppDefinition();\r\n    LogUtil.info(\"PK:\", \"\"+ formData);\r\n    \r\n    Map paramValues = FormUtil.loadFormData(appDef.getAppId(), appDef.getVersion().toString(), \"processo\", \"3652_workflowPL_CreditoHabitacao\", true, true, true, null);//FALTA PK\r\n    LogUtil.info(\"Param Val 1:\", \"\"+ paramValues);\r\n    //LogUtil.info(\"ParamVAL 0r\", \"\" + paramValues.get(0));\r\n    \r\n    \r\n    \r\n    FormRow originalRow = rows.get(0);\r\n    \r\n    \r\n    \r\n    \r\n    String proximaoperativa = \"#variable.proxima_operativa#\";\r\n    var SLAIsOpen = false;\r\n    var SLAOnHold = false;\r\n    \r\n    Connection con = null;\r\n    PreparedStatement stmt = null;\r\n    ResultSet rs = null;\r\n    try{\r\n            DataSource ds = (DataSource)AppUtil.getApplicationContext().getBean(\"setupDataSource\");\r\n            con = ds.getConnection();\r\n            \r\n            if(!con.isClosed()){\r\n                \r\n                \r\n                //Verificar se existe algum SLA do processo em aberto\r\n                String queryGetOpenSLA = \"SELECT id FROM app_fd_sla_atividade WHERE c_id_processo=? AND c_estado_atividade = 'Em curso';\";\r\n                stmt = con.prepareStatement(queryGetOpenSLA);\r\n                stmt.setObject(1, ProcessID);\r\n                rs = stmt.executeQuery();\r\n                \r\n                if(rs.next()){\r\n                    SLAIsOpen = true;\r\n                }\r\n                \r\n                //Verificar se existe algum SLA do processo pendente\r\n                String queryGetOnHoldSLA = \"SELECT id FROM app_fd_sla_atividade WHERE c_id_processo=? AND c_estado_atividade = 'Pendente';\";\r\n                stmt = con.prepareStatement(queryGetOnHoldSLA);\r\n                stmt.setObject(1, ProcessID);\r\n                rs = stmt.executeQuery();\r\n                \r\n                if(rs.next()){\r\n                    SLAOnHold = true;\r\n                }\r\n               \r\n               //Se o estado de contratação for pendente\r\n               if(EstadoContratacao == \"PND\"){\r\n                   \r\n                   //Se o SLA estiver 'Em curso'\r\n                   if(SLAIsOpen){\r\n                       //Atualizar o sla Em curso para fechado\r\n                        String queryReset= \"UPDATE app_fd_sla_atividade SET c_estado_atividade = 'Fechada' WHERE c_id_processo=? AND c_estado_atividade = 'Em curso';\"; \r\n                        stmt = con.prepareStatement(queryReset);\r\n                        stmt.setObject(1, ProcessID);\r\n                        rs = stmt.executeQuery();\r\n                       \r\n                       LogUtil.info(\"ProcessID:\", \"\"+ ProcessId);\r\n                       \r\n                       //Obter detalhes da tarefa\r\n                        String queryGetAssignment = \"SELECT name FROM shkprocesses WHERE id=?;\";\r\n                        String queryGetUserAssign = \"SELECT resourceid FROM shkassignmentstable WHERE activityprocessid =?\";\r\n                        String nomeAtividade = \"\";\r\n                        String utilizador = \"\";\r\n                        stmt = con.prepareStatement(queryGetAssignment);\r\n                        stmt.setObject(1, ProcessID);\r\n                        rs = stmt.executeQuery();\r\n                        \r\n                        if(rs.next()){\r\n                            nomeAtividade= rs.getObject(\"name\").toString();\r\n                        }\r\n                        \r\n                        stmt = con.prepareStatement(queryGetUserAssign);\r\n                        stmt.setObject(1, ProcessID);\r\n                        rs = stmt.executeQuery();\r\n                        \r\n                        if(rs.next()){\r\n                            utilizador= rs.getObject(\"resourceid\").toString();\r\n                        }\r\n                       \r\n                       //Criar SLA Pendente\r\n                       String queryCreateSLA = \"INSERT INTO app_fd_sla_atividade (id, dateCreated, dateModified, createdBy,createdByName ,modifiedBy, modifiedByName, c_data_inicio, c_data_fim, c_nome_atividade, c_sla, c_id_processo, c_utilizador_atribuido, c_estado_atividade) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?);\";\r\n                       stmt = con.prepareStatement(queryCreateSLA);\r\n                       \r\n                       var idSLA = UuidGenerator.getInstance().getUuid();\r\n                       var dateNow =\"#date.yyyy-MM-dd HH:mm#\";\r\n                       var currentUsername = \"#currentUser.username#\";\r\n                       var currentNameUser = \"#currentUser.firstName#\" + \"#currentUser.lastName#\";\r\n                       String dataFim = calculateSLAD(dateNow);\r\n                       \r\n                       var estadoAtividade = \"Pendente\";\r\n                       stmt.setObject(1, idSLA);\r\n                       stmt.setObject(2, dateNow);\r\n                       stmt.setObject(3, dateNow);\r\n                       stmt.setObject(4, currentUsername);\r\n                       stmt.setObject(5, currentNameUser);\r\n                       stmt.setObject(6, currentUsername);\r\n                       stmt.setObject(7, currentNameUser);\r\n                       stmt.setObject(8, dateNow);\r\n                       stmt.setObject(9, dataFim);   //Falta calcular a data de Fim\r\n                       stmt.setObject(10, nomeAtividade);\r\n                       stmt.setObject(11, ProcessID);\r\n                       stmt.setObject(12, ProcessID);\r\n                       stmt.setObject(13, utilizador);\r\n                       stmt.setObject(14, estadoAtividade);\r\n    \r\n                       rs = stmt.executeQuery();\r\n                   }\r\n                   \r\n                   \r\n                   //Caso o estado de contratação esteja a pendente\r\n               }else{\r\n                   \r\n                   //Se existir algum SLA pendente\r\n                   if(SLAOnHold){\r\n                       //Atualizar o sla de Pendente para Em curso\r\n                        String queryReset= \"UPDATE app_fd_sla_atividade SET c_estado_atividade = 'Em curso' WHERE c_id_processo=? AND c_estado_atividade = 'Pendente';\"; \r\n                        stmt = con.prepareStatement(queryReset);\r\n                        stmt.setObject(1, ProcessID);\r\n                        rs = stmt.executeQuery();\r\n                   }\r\n               }\r\n            }\r\n            \r\n        }catch(Exception e){\r\n            LogUtil.error(appDef.toString(), e, \"Error getting info from DB\");\r\n        }finally{\r\n            try{\r\n                if(rs != null){\r\n                rs.close();\r\n                }\r\n                if(stmt != null){\r\n                    stmt.close();\r\n                }\r\n                if(con != null && !con.isClosed()) {\r\n                    con.close();\r\n                }\r\n            }catch(Exception e){\r\n                LogUtil.error(appDef.toString(), e, \"Error closing DB connection\");\r\n            }\r\n            \r\n        }\r\n    \r\n    \r\n    \r\n    \r\n    return rows;\r\n}\r\nreturn store(element, rows, formData); ",
                "useAjax": ""
            }
        },
        "tableName": "processos"
    }
}